import{c as E,r,t as _,j as e,B as m,s as I,aa as B,V as q,W as K,X as $,Z as A,d as H,D as O,o as X,v as U,p as W,x as Z,w as J}from"./index-BkZ1fbvE.js";import{s as Q,d as Y,c as ee,u as se}from"./guideline-Bbhb0vb9.js";import{D as ae,a as te,b as le,c as ie,d as re,f as ne,g as oe}from"./dialog-DdHcYUWU.js";import{L as C}from"./label-BPYBCH7t.js";import{S as R,a as F,b as G,c as L,d as w}from"./select-BVe2FuYJ.js";import{T as k}from"./textarea-DrbJn6hG.js";import{I as ce,a as de,b as xe,c as he,d as ue}from"./IconPlus-DCu00Qm-.js";import{T as V,a as me,b as T,c as N,d as pe,e as f}from"./table-D5oD5D8Z.js";import{B as je}from"./badge-D8rsmH0n.js";import"./index-BdQq_4o_.js";import"./index-JW4qzHJT.js";/**
 * @license @tabler/icons-react v3.34.1 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */const fe=[["path",{d:"M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4",key:"svg-0"}],["path",{d:"M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4",key:"svg-1"}]],ge=E("outline","refresh","Refresh",fe);function ve(){const[s,d]=r.useState(!1),[p,h]=r.useState({items:[],total:0,page:1,size:10,has_next:!1,has_prev:!1}),[l,x]=r.useState({title:"",condition:"",action:"",status:"all",priority_min:void 0,priority_max:void 0,orderby:"id",order:"desc",page:1,size:10}),o=r.useCallback(async()=>{d(!0);try{const t=await Q({title:l.title||void 0,condition:l.condition||void 0,action:l.action||void 0,status:l.status!=="all"?l.status:void 0,priority_min:l.priority_min,priority_max:l.priority_max,orderby:l.orderby,order:l.order,page:l.page,size:l.size});h(t)}catch(t){console.error("获取指南失败:",t),_.error("获取指南失败"),h({items:[],total:0,page:1,size:10,has_next:!1,has_prev:!1})}finally{d(!1)}},[l]),g=r.useCallback(t=>{x(n=>({...n,...t,page:1}))},[]),y=r.useCallback(()=>{x({title:"",condition:"",action:"",status:"all",priority_min:void 0,priority_max:void 0,orderby:"id",order:"desc",page:1,size:10})},[]),D=r.useCallback(t=>{x(n=>({...n,page:t}))},[]),v=r.useCallback(t=>{x(n=>({...n,page:1,size:t}))},[]),c=r.useCallback(()=>{o()},[o]),j=r.useCallback(t=>{h(n=>({...n,items:n.items.map(u=>u.id===t.id?{...u,...t}:u)}))},[]),i=r.useCallback(async t=>{try{await Y(t),o()}catch(n){console.error("删除指南失败:",n)}},[o]);return r.useEffect(()=>{o()},[o]),{guidelineData:p,searchParams:l,loading:s,handleSearch:g,handleReset:y,handlePageChange:D,handlePageSizeChange:v,handleRefresh:c,updateLocalGuideline:j,handleDelete:i}}function P({item:s,type:d,onSave:p,onUpdateLocal:h}){const[l,x]=r.useState(!1),[o,g]=r.useState(!1),y=c=>{c.key==="Enter"&&!c.shiftKey&&c.preventDefault()},D=r.forwardRef(({className:c,variant:j,size:i,children:t,...n},u)=>e.jsx(m,{ref:u,className:c,variant:j,size:i,...n,children:t}));D.displayName="TriggerButton";const v=r.forwardRef(({children:c,...j},i)=>e.jsx("span",{ref:i,...j,children:c}));return v.displayName="TriggerSpan",e.jsxs(ae,{open:l,onOpenChange:x,children:[e.jsx(te,{asChild:!0,children:d==="add"?e.jsxs(D,{variant:"default",children:[e.jsx(ce,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden lg:inline ml-2",children:"新增指南"})]}):d==="edit"?e.jsx(v,{className:"inline-block max-w-full cursor-pointer hover:underline truncate",title:s?.title,children:s?.title}):e.jsx("button",{type:"button",className:"w-full h-8 px-2 py-1 text-sm",children:"编辑"})}),e.jsx(le,{className:"sm:max-w-[800px]",onKeyDown:y,children:e.jsxs("form",{onSubmit:async c=>{c.preventDefault(),g(!0);const j=new Promise((i,t)=>{setTimeout(()=>t(new Error("请求超时，请检查网络连接")),3e4)});try{const i=new FormData(c.target),t=i.get("title"),n=i.get("condition"),u=i.get("action"),S=i.get("prompt_template"),z=parseInt(i.get("priority")),a=i.get("status");if(!t||!n||!u){_.error("请填写所有必填字段");return}if(d==="add")await Promise.race([ee({title:t,condition:n,action:u,prompt_template:S||void 0,priority:z,status:a}),j]),p&&p();else{const b=await Promise.race([se(s.id,{title:t,condition:n,action:u,prompt_template:S||void 0,priority:z,status:a}),j]);h&&h({...s,...b})}x(!1)}catch(i){console.error("保存指南失败:",i),i.message==="请求超时，请检查网络连接"?_.error("请求超时，请检查网络连接后重试"):i.response?.data?.detail?_.error(i.response.data.detail):_.error("操作失败，请重试")}finally{g(!1)}},children:[e.jsx(ie,{children:e.jsx(re,{children:d==="edit"?`编辑指南: ${s?.id}`:"新增指南"})}),e.jsxs("div",{className:"flex flex-col gap-4 py-4",children:[e.jsxs("div",{children:[e.jsx(C,{htmlFor:"title",children:"标题 *"}),e.jsx(I,{id:"title",name:"title",defaultValue:s?.title,placeholder:"请输入指南标题",required:!0})]}),e.jsxs("div",{children:[e.jsx(C,{htmlFor:"condition",children:"触发条件 *"}),e.jsx(k,{id:"condition",name:"condition",defaultValue:s?.condition,placeholder:"描述触发此指南的条件,例如:用户提问 为什么保费变多了",required:!0,rows:3})]}),e.jsxs("div",{children:[e.jsx(C,{htmlFor:"action",children:"行动内容 *"}),e.jsx(k,{id:"action",name:"action",defaultValue:s?.action,placeholder:"描述采取的行动,例如:为什么保费变多了",required:!0,rows:3})]}),e.jsxs("div",{children:[e.jsx(C,{htmlFor:"prompt_template",children:"Prompt 模板（可选）"}),e.jsx(k,{id:"prompt_template",name:"prompt_template",defaultValue:s?.prompt_template,placeholder:"自定义 Prompt 模板，留空使用默认模板",rows:4}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"如果填写，将覆盖默认的行动指南格式"})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(C,{htmlFor:"priority",children:"优先级 *"}),e.jsx(I,{id:"priority",name:"priority",type:"number",min:"1",max:"10",defaultValue:s?.priority||5,required:!0}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"1-10，数字越大优先级越高"})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx(C,{htmlFor:"status",children:"状态 *"}),e.jsxs(R,{name:"status",defaultValue:s?.status||"D",children:[e.jsx(F,{children:e.jsx(G,{})}),e.jsxs(L,{children:[e.jsx(w,{value:"A",children:"已启用"}),e.jsx(w,{value:"I",children:"已禁用"}),e.jsx(w,{value:"D",children:"草稿"})]})]})]})]})]}),e.jsxs(ne,{children:[e.jsx(oe,{asChild:!0,children:e.jsx(m,{type:"button",variant:"outline",children:"取消"})}),e.jsx(m,{type:"submit",disabled:o,children:o?"保存中...":"保存"})]})]})})]})}function M({content:s,maxLength:d=100,className:p=""}){const[h,l]=r.useState(!1);if(!s)return e.jsx("span",{className:p,children:"-"});const x=s.length>d,o=h||!x?s:s.slice(0,d)+"...";return e.jsx(B,{children:e.jsxs(q,{children:[e.jsx(K,{asChild:!0,children:e.jsxs("div",{className:p,children:[e.jsx("span",{className:"whitespace-pre-wrap",children:o}),x&&e.jsx("button",{onClick:g=>{g.stopPropagation(),l(!h)},className:"ml-2 text-xs text-blue-500 hover:text-blue-700 underline",children:h?"收起":"展开"})]})}),e.jsx($,{className:"max-w-md",children:e.jsx("p",{className:"whitespace-pre-wrap text-sm",children:s})})]})})}function Pe(){const{guidelineData:s,loading:d,handleSearch:p,handleReset:h,handlePageChange:l,handleRefresh:x,updateLocalGuideline:o,handleDelete:g}=ve(),[y,D]=r.useState(""),[v,c]=r.useState("all"),[j,i]=r.useState(s.size),t=()=>{p({title:y,status:v})},n=a=>new Date(a).toLocaleString("zh-CN"),u=a=>{const b={A:{label:"已启用",color:"text-green-500"},I:{label:"已禁用",color:"text-gray-500"},D:{label:"草稿",color:"text-yellow-500"},X:{label:"已删除",color:"text-red-500"}};return b[a]||b.D},S=Math.ceil(s.total/s.size),z=a=>{i(a),p({title:y,status:v,size:a})};return e.jsxs("div",{className:"w-full h-full flex flex-col gap-6",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 lg:px-6 py-2",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"行动指南管理"}),e.jsxs("div",{className:"w-2/3 flex items-center gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(A,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),e.jsx(I,{placeholder:"搜索标题...",className:"pl-10",value:y,onChange:a=>D(a.target.value),onKeyDown:a=>a.key==="Enter"&&t()})]}),e.jsxs(R,{value:v,onValueChange:a=>c(a),children:[e.jsx(F,{className:"w-32",children:e.jsx(G,{placeholder:"状态"})}),e.jsxs(L,{children:[e.jsx(w,{value:"all",children:"全部状态"}),e.jsx(w,{value:"A",children:"已启用"}),e.jsx(w,{value:"I",children:"已禁用"}),e.jsx(w,{value:"D",children:"草稿"})]})]}),e.jsx(m,{onClick:t,children:"搜索"}),e.jsx(m,{variant:"outline",onClick:h,children:"重置"}),e.jsxs(m,{variant:"outline",onClick:x,children:[e.jsx(ge,{className:H("h-4 w-4 mr-1",d&&"animate-spin")}),"刷新"]}),e.jsx(P,{type:"add",onSave:x})]})]}),e.jsx("div",{className:"flex-1 flex flex-col overflow-hidden",children:e.jsxs("div",{className:"overflow-hidden rounded-lg border flex-1 flex flex-col",children:[e.jsx("div",{className:"overflow-hidden",children:e.jsx(V,{children:e.jsx(me,{className:"bg-muted",children:e.jsxs(T,{children:[e.jsx(N,{className:"w-[80px]",children:"ID"}),e.jsx(N,{className:"w-[300px]",children:"标题"}),e.jsx(N,{className:"w-[400px]",children:"触发条件"}),e.jsx(N,{className:"w-[400px]",children:"行动内容"}),e.jsx(N,{className:"w-[100px]",children:"优先级"}),e.jsx(N,{className:"w-[100px]",children:"状态"}),e.jsx(N,{className:"w-[180px]",children:"创建时间"}),e.jsx(N,{className:"w-[80px]",children:"操作"})]})})})}),e.jsx("div",{className:"overflow-auto flex-1",children:e.jsx(V,{children:e.jsx(pe,{children:d?e.jsx(T,{children:e.jsx(f,{colSpan:8,className:"text-center py-8",children:"加载中..."})}):s.items.length===0?e.jsx(T,{children:e.jsx(f,{colSpan:8,className:"text-center py-8",children:"暂无数据"})}):s.items.map(a=>{const b=u(a.status);return e.jsxs(T,{children:[e.jsx(f,{className:"font-medium",children:a.id}),e.jsx(f,{children:e.jsx(P,{item:a,type:"edit",onUpdateLocal:o})}),e.jsx(f,{children:e.jsx(M,{content:a.condition,maxLength:80})}),e.jsx(f,{children:e.jsx(M,{content:a.action,maxLength:80})}),e.jsx(f,{children:a.priority}),e.jsx(f,{children:e.jsx(je,{variant:"outline",className:b.color,children:b.label})}),e.jsx(f,{children:n(a.created_time)}),e.jsx(f,{children:e.jsxs(O,{children:[e.jsx(X,{asChild:!0,children:e.jsx(m,{variant:"ghost",size:"icon",children:e.jsx(U,{className:"h-4 w-4"})})}),e.jsxs(W,{align:"end",children:[e.jsx(P,{item:a,type:"row_edit",onUpdateLocal:o}),e.jsx(Z,{}),e.jsx(J,{className:"text-destructive",onClick:()=>{confirm(`确定要删除指南 "${a.title}" 吗？`)&&g(a.id)},children:"删除"})]})]})})]},a.id)})})})}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-2 border-t shrink-0",children:[e.jsxs("div",{className:"text-muted-foreground hidden flex-1 text-sm lg:flex",children:["共 ",s.total," 条数据"]}),e.jsxs("div",{className:"flex w-full items-center gap-8 lg:w-fit",children:[e.jsxs("div",{className:"hidden items-center gap-2 lg:flex",children:[e.jsx(C,{htmlFor:"rows-per-page",className:"text-sm font-medium",children:"每页行数"}),e.jsxs(R,{value:`${j}`,onValueChange:a=>z(Number(a)),children:[e.jsx(F,{className:"w-20",size:"sm",id:"rows-per-page",children:e.jsx(G,{})}),e.jsx(L,{side:"top",children:[10,20,30,40,50,100].map(a=>e.jsx(w,{value:`${a}`,children:a},a))})]})]}),e.jsxs("div",{className:"text-sm font-medium",children:["第 ",s.page," 页，共 ",S," 页"]}),e.jsxs("div",{className:"ml-auto flex items-center gap-2 lg:ml-0",children:[e.jsx(m,{variant:"outline",className:"hidden lg:flex size-8",size:"icon",onClick:()=>l(1),disabled:s.page<=1,children:e.jsx(de,{className:"size-4"})}),e.jsx(m,{variant:"outline",className:"size-8",size:"icon",onClick:()=>l(s.page-1),disabled:!s.has_prev,children:e.jsx(xe,{className:"size-4"})}),e.jsx(m,{variant:"outline",className:"size-8",size:"icon",onClick:()=>l(s.page+1),disabled:!s.has_next,children:e.jsx(he,{className:"size-4"})}),e.jsx(m,{variant:"outline",className:"hidden lg:flex size-8",size:"icon",onClick:()=>l(S),disabled:!s.has_next||s.page>=S,children:e.jsx(ue,{className:"size-4"})})]})]})]})]})})]})}export{Pe as default};
