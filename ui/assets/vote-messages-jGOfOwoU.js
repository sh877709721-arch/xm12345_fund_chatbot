import{r as i,t as O,j as e,d as w,s as Q,B as g,a8 as F}from"./index-BkZ1fbvE.js";import{u as $,f as L,b as A,c as G,d as J,e as U}from"./index-BjZ7u3zq.js";import{B as W}from"./badge-D8rsmH0n.js";import{D as q,C as X}from"./date-input-CPHms4xx.js";import{S as T,a as M,b as V,c as I,d as x}from"./select-BVe2FuYJ.js";import{T as H,a as Y,b as C,c as Z,d as ee,e as E}from"./table-D5oD5D8Z.js";import{g as ae,e as se,T as te,M as le,a as ne}from"./vote-XaGOkas7.js";import{S as re}from"./search-CLI9qL7o.js";import{R as ie,D as ce,C as de,a as oe}from"./refresh-cw-Bc2JsiUX.js";import"./popover-DRNDwRi0.js";import"./index-BdQq_4o_.js";import"./index-JW4qzHJT.js";function he(){const[r,c]=i.useState(!1),[l,m]=i.useState({items:[],total:0,page:1,size:10,has_next:!1,has_prev:!1}),[s,h]=i.useState({vote_type:"all",page:1,size:10,start_date:new Date().toISOString().split("T")[0],end_date:"",searchKeyword:"",client_type:""}),[j,S]=i.useState(new Map),y=i.useCallback(t=>JSON.stringify({vote_type:t.vote_type,page:t.page,size:t.size,start_date:t.start_date,end_date:t.end_date,searchKeyword:t.searchKeyword,client_type:t.client_type}),[]),f=i.useCallback(async(t=!1)=>{const n=y(s);if(!t&&j.has(n)){const d=j.get(n);return m({items:d.items,total:d.total,page:s.page,size:s.size,has_next:s.page<Math.ceil(d.total/s.size),has_prev:s.page>1}),d}c(!0);try{const d={page:s.page,size:s.size,vote_type:s.vote_type==="all"?void 0:s.vote_type,start_date:s.start_date||void 0,end_date:s.end_date||void 0,searchKeyword:s.searchKeyword||void 0,client_type:s.client_type||void 0},p=await ae(d);return S(a=>new Map(a).set(n,p)),m({items:p.items,total:p.total,page:s.page,size:s.size,has_next:s.page<Math.ceil(p.total/s.size),has_prev:s.page>1}),p}catch(d){throw console.error("获取投票数据失败:",d),O.error("获取投票数据失败"),m({items:[],total:0,page:1,size:10,has_next:!1,has_prev:!1}),d}finally{c(!1)}},[s,y,j]),N=i.useCallback(t=>{h(n=>({...n,searchKeyword:t!==void 0?t:n.searchKeyword,page:1}))},[]),z=i.useCallback(()=>{h({vote_type:"all",page:1,size:10,start_date:new Date().toISOString().split("T")[0],end_date:"",searchKeyword:"",client_type:""})},[]),k=i.useCallback(t=>{h(n=>({...n,vote_type:t,page:1}))},[]),K=i.useCallback((t,n)=>{h(d=>({...d,start_date:t,end_date:n,page:1}))},[]),R=i.useCallback(t=>{h(n=>({...n,client_type:t==="all"?"":t,page:1}))},[]),_=i.useCallback(t=>{h(n=>({...n,page:t}))},[]),b=i.useCallback(t=>{h(n=>({...n,page:1,size:t}))},[]),D=i.useCallback(()=>f(!0),[f]);i.useEffect(()=>{f()},[f]);const v=Math.ceil(l.total/l.size),P=l.page<v,u=l.page>1;return{voteData:l,searchParams:s,loading:r,totalPages:v,hasNextPage:P,hasPrevPage:u,handleSearch:N,handleReset:z,handleVoteTypeChange:k,handleDateRangeChange:K,handleClientTypeChange:R,handlePageChange:_,handlePageSizeChange:b,handleRefresh:D}}const xe=r=>new Date(r).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}),me=r=>{switch(r){case"good":return"default";case"medium":return"secondary";case"bad":return"destructive";default:return"outline"}},ge=(r,c)=>{switch(r){case"good":return e.jsx(ne,{className:w("h-4 w-4 text-green-600",c)});case"medium":return e.jsx(le,{className:w("h-4 w-4 text-yellow-600",c)});case"bad":return e.jsx(te,{className:w("h-4 w-4 text-red-600",c)});default:return null}},ue=r=>{switch(r){case"good":return"好评";case"medium":return"中评";case"bad":return"差评";default:return"未知"}},B=({content:r,maxLength:c=100})=>{const[l,m]=i.useState(!1);if(!r||r.trim()==="")return null;const s=r.length>c;if(!s)return e.jsx("div",{className:"text-sm leading-relaxed whitespace-pre-wrap",children:r});const h=l?r:r.slice(0,c)+"...";return e.jsxs("div",{className:"relative group",children:[e.jsx("div",{className:"text-sm leading-relaxed whitespace-pre-wrap",children:h}),e.jsx("div",{className:"invisible group-hover:visible absolute z-50 max-w-md p-3 bg-popover border rounded-md shadow-lg",children:e.jsx("div",{className:"text-sm leading-relaxed whitespace-pre-wrap max-h-64 overflow-y-auto",children:r})}),s&&e.jsx(g,{variant:"ghost",size:"sm",onClick:()=>m(!l),className:"mt-1 h-6 px-2 text-xs",children:l?"收起":"展开"})]})};function pe({className:r}){const{voteData:c,searchParams:l,loading:m,totalPages:s,hasNextPage:h,hasPrevPage:j,handleSearch:S,handleReset:y,handleVoteTypeChange:f,handleDateRangeChange:N,handleClientTypeChange:z,handlePageChange:k,handlePageSizeChange:K,handleRefresh:R}=he(),[_,b]=i.useState(l.searchKeyword||"");i.useEffect(()=>{b(l.searchKeyword||"")},[l.searchKeyword]);const D=a=>{b(a)},v=()=>{S(_)},P=a=>{a.key==="Enter"&&(a.preventDefault(),v())},u=[{accessorKey:"vote_type",header:()=>e.jsx("div",{className:"pl-6",children:"投票类型"}),cell:({row:a})=>e.jsxs("div",{className:"flex items-center gap-2",children:[ge(a.original.vote_type)||e.jsx("div",{className:"w-4 h-4"}),e.jsx(W,{variant:me(a.original.vote_type),children:ue(a.original.vote_type)})]}),size:120,enableSorting:!0},{accessorKey:"client_type",header:"请求来源",cell:({row:a})=>e.jsx("span",{className:"text-sm text-muted-foreground",children:a.original.client_type||"未知"}),size:120,enableSorting:!1},{accessorKey:"message_id",header:"消息ID",cell:({row:a})=>e.jsx("span",{className:"font-mono text-sm text-muted-foreground",children:a.original.message_id}),size:100,enableSorting:!0},{accessorKey:"question",header:"用户问题",cell:({row:a})=>e.jsx("div",{className:"max-w-xs",children:e.jsx(B,{content:a.original.question,maxLength:80})}),size:250,enableSorting:!1},{accessorKey:"answer",header:"AI回答",cell:({row:a})=>e.jsx("div",{className:"max-w-md",children:e.jsx(B,{content:a.original.answer,maxLength:150})}),size:400,enableSorting:!1},{accessorKey:"feedback",header:"反馈内容",cell:({row:a})=>e.jsx("div",{className:"max-w-md",children:e.jsx(B,{content:a.original.feedback,maxLength:150})}),size:180,enableSorting:!1},{accessorKey:"updated_at",header:"消息时间",cell:({row:a})=>e.jsx("span",{className:"text-sm text-muted-foreground",children:xe(a.original.created_at)}),size:150,enableSorting:!0}],t=$({data:c.items,columns:u,enableRowSelection:!1,getCoreRowModel:U(),getFilteredRowModel:J(),getPaginationRowModel:G(),getSortedRowModel:A(),manualPagination:!0,manualSorting:!1,pageCount:s}),n=a=>{k(a)},d=a=>{K(Number(a))},p=async()=>{try{const a={vote_type:l.vote_type==="all"?void 0:l.vote_type,start_date:l.start_date||void 0,end_date:l.end_date||void 0,searchKeyword:l.searchKeyword||void 0,client_type:l.client_type||void 0};await se(a)}catch(a){console.error("导出失败:",a)}};return e.jsxs("div",{className:w("w-full h-full flex flex-col",r),children:[e.jsx("div",{className:"py-2 flex-shrink-0",children:e.jsxs("div",{className:"flex flex-wrap gap-3",children:[e.jsxs("div",{className:"relative flex-1 min-w-[200px]",children:[e.jsx(re,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),e.jsx(Q,{placeholder:"搜索问题或回答...",value:_,onChange:a=>{D(a.target.value)},onKeyDown:P,onBlur:v,className:"pl-8 h-8"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm text-muted-foreground whitespace-nowrap",children:"投票类型："}),e.jsxs(T,{value:l.vote_type,onValueChange:f,children:[e.jsx(M,{className:"w-28 h-8",children:e.jsx(V,{placeholder:"投票类型"})}),e.jsxs(I,{children:[e.jsx(x,{value:"all",children:"全部"}),e.jsx(x,{value:"good",children:"好评"}),e.jsx(x,{value:"medium",children:"中评"}),e.jsx(x,{value:"bad",children:"差评"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm text-muted-foreground whitespace-nowrap",children:"请求来源："}),e.jsxs(T,{value:l.client_type||"all",onValueChange:z,children:[e.jsx(M,{className:"w-28 h-8",children:e.jsx(V,{placeholder:"请求来源"})}),e.jsxs(I,{children:[e.jsx(x,{value:"all",children:"全部"}),e.jsx(x,{value:"web",children:"网页"}),e.jsx(x,{value:"h5",children:"H5"}),e.jsx(x,{value:"miniprogram",children:"小程序"}),e.jsx(x,{value:"mp",children:"公众号"}),e.jsx(x,{value:"公积金",children:"公积金"}),e.jsx(x,{value:"rexian",children:"热线"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm text-muted-foreground whitespace-nowrap",children:"开始日期时间："}),e.jsx(q,{value:l.start_date,onChange:a=>N(a||"",l.end_date),placeholder:"开始日期时间"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm text-muted-foreground whitespace-nowrap",children:"结束日期时间："}),e.jsx(q,{value:l.end_date,onChange:a=>N(l.start_date,a||""),placeholder:"结束日期时间"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(g,{onClick:R,disabled:m,className:"h-8",children:[e.jsx(ie,{className:w("h-3 w-3 mr-1",m&&"animate-spin")}),"刷新"]}),e.jsx(g,{variant:"secondary",onClick:y,className:"h-8",children:"重置"}),e.jsxs(g,{onClick:p,disabled:m,variant:"outline",className:"h-8",children:[e.jsx(ce,{className:"h-3 w-3 mr-1"}),"导出Excel"]})]})]})}),e.jsx("div",{className:"flex-1 flex flex-col overflow-hidden",children:e.jsxs("div",{className:"h-full rounded-lg border flex flex-col min-h-0",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsxs(H,{className:"w-full table-fixed",children:[e.jsx("colgroup",{children:u.map((a,o)=>e.jsx("col",{style:{width:a.size}},o))}),e.jsx(Y,{className:"bg-muted",children:t.getHeaderGroups().map(a=>e.jsx(C,{children:a.headers.map(o=>e.jsx(Z,{colSpan:o.colSpan,className:"align-middle",children:o.isPlaceholder?null:L(o.column.columnDef.header,o.getContext())},o.id))},a.id))})]})}),e.jsx("div",{className:"overflow-auto flex-1",children:e.jsxs(H,{className:"w-full table-fixed",children:[e.jsx("colgroup",{children:u.map((a,o)=>e.jsx("col",{style:{width:a.size}},o))}),e.jsx(ee,{children:m?e.jsx(C,{children:e.jsx(E,{colSpan:u.length,className:"h-24 text-center",children:"加载中..."})}):t.getRowModel().rows.length?t.getRowModel().rows.map(a=>e.jsx(C,{"data-state":a.getIsSelected()&&"selected",children:a.getVisibleCells().map(o=>e.jsx(E,{className:"align-middle py-2",children:L(o.column.columnDef.cell,o.getContext())},o.id))},a.id)):e.jsx(C,{children:e.jsx(E,{colSpan:u.length,className:"h-24 text-center",children:"无数据"})})})]})}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-2 border-t flex-shrink-0",children:[e.jsxs("div",{className:"text-muted-foreground hidden flex-1 text-sm lg:flex",children:["共 ",c.total," 条数据"]}),e.jsxs("div",{className:"flex w-full items-center gap-8 lg:w-fit",children:[e.jsxs("div",{className:"hidden items-center gap-2 lg:flex",children:[e.jsx("span",{className:"text-sm font-medium",children:"每页行数"}),e.jsxs(T,{value:`${l.size}`,onValueChange:d,children:[e.jsx(M,{className:"w-20",size:"sm",children:e.jsx(V,{})}),e.jsx(I,{side:"top",children:[10,20,30,40,50,100,500,1e3].map(a=>e.jsx(x,{value:`${a}`,children:a},a))})]})]}),e.jsxs("div",{className:"text-sm font-medium",children:["第 ",c.page," 页，共 ",s," 页"]}),e.jsxs("div",{className:"ml-auto flex items-center gap-2 lg:ml-0",children:[e.jsx(g,{variant:"outline",className:"hidden lg:flex size-8",size:"icon",onClick:()=>n(1),disabled:c.page<=1,children:e.jsx(de,{className:"size-4"})}),e.jsx(g,{variant:"outline",className:"size-8",size:"icon",onClick:()=>n(c.page-1),disabled:!j,children:e.jsx(X,{className:"size-4"})}),e.jsx(g,{variant:"outline",className:"size-8",size:"icon",onClick:()=>n(c.page+1),disabled:!h,children:e.jsx(F,{className:"size-4"})}),e.jsx(g,{variant:"outline",className:"hidden lg:flex size-8",size:"icon",onClick:()=>n(s),disabled:!h||c.page>=s,children:e.jsx(oe,{className:"size-4"})})]})]})]})]})})]})}function Ke(){return e.jsx("div",{className:"flex gap-2 h-full",children:e.jsx("div",{className:"flex-1 flex flex-col p-6",children:e.jsx(pe,{})})})}export{Ke as default};
