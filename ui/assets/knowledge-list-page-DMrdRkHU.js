import{c as X,r as o,j as e,B as y,z as ge,R as H,s as U,t as c,V as ze,W as De,X as Ke,Y as ee,Z as $e,D as Te,o as Ee,v as Me,p as Fe,x as Pe,w as Ie}from"./index-BkZ1fbvE.js";import{u as Re,f as re,b as Le,c as Ae,d as Ve,e as Oe}from"./index-BjZ7u3zq.js";import{B as ce}from"./badge-D8rsmH0n.js";import{c as me,a as ue,b as qe,u as pe,d as He,s as Be,e as Ue}from"./permission-3MV1YRl5.js";import{D as fe,a as We,b as ve,c as je,d as we,e as Ne,f as Xe,g as Ge}from"./dialog-DdHcYUWU.js";import{L as V}from"./label-BPYBCH7t.js";import{S as G,a as Y,b as Z,c as J,d as M}from"./select-BVe2FuYJ.js";import{T as oe}from"./textarea-DZUYYOaG.js";import{I as B,a as Ye}from"./IconLoader-_wguQh1K.js";import{c as Q,I as ye,a as Ze,b as Je,d as Qe}from"./IconPlus-DCu00Qm-.js";import{D as es,b as ss,c as as,d as ls,f as ts,g as ns,I as rs}from"./drawer-HN2_FTBb.js";import{T as ie,a as cs,b as ae,c as os,d as is,e as le}from"./table-D5oD5D8Z.js";import{e as ds}from"./card-CXEOfyPU.js";import"./index-BdQq_4o_.js";import"./index-JW4qzHJT.js";/**
 * @license @tabler/icons-react v3.34.1 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */const xs=[["path",{d:"M6 15l6 -6l6 6",key:"svg-0"}]],te=X("outline","chevron-up","ChevronUp",xs);/**
 * @license @tabler/icons-react v3.34.1 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */const hs=[["path",{d:"M7 7h-1a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-1",key:"svg-0"}],["path",{d:"M20.385 6.585a2.1 2.1 0 0 0 -2.97 -2.97l-8.415 8.385v3h3l8.385 -8.415z",key:"svg-1"}],["path",{d:"M16 5l3 3",key:"svg-2"}]],gs=X("outline","edit","Edit",hs);/**
 * @license @tabler/icons-react v3.34.1 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */const ms=[["path",{d:"M14 3v4a1 1 0 0 0 1 1h4",key:"svg-0"}],["path",{d:"M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z",key:"svg-1"}],["path",{d:"M8 11h8v7h-8z",key:"svg-2"}],["path",{d:"M8 15h8",key:"svg-3"}],["path",{d:"M11 11v7",key:"svg-4"}]],de=X("outline","file-spreadsheet","FileSpreadsheet",ms);/**
 * @license @tabler/icons-react v3.34.1 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */const us=[["path",{d:"M5 4h4l3 3h7a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-11a2 2 0 0 1 2 -2",key:"svg-0"}]],W=X("outline","folder","Folder",us);/**
 * @license @tabler/icons-react v3.34.1 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */const ps=[["path",{d:"M4 7l16 0",key:"svg-0"}],["path",{d:"M10 11l0 6",key:"svg-1"}],["path",{d:"M14 11l0 6",key:"svg-2"}],["path",{d:"M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12",key:"svg-3"}],["path",{d:"M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3",key:"svg-4"}]],fs=X("outline","trash","Trash",ps);/**
 * @license @tabler/icons-react v3.34.1 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */const vs=[["path",{d:"M18 6l-12 12",key:"svg-0"}],["path",{d:"M6 6l12 12",key:"svg-1"}]],js=X("outline","x","X",vs),_e=({catalogTree:l,catalogs:a,selectedCatalogId:d,onCatalogSelect:$,loading:x=!1})=>{const[j,f]=o.useState(new Set(["root"]));o.useEffect(()=>{if(d&&a.length>0){const r=a.find(i=>i.id===d);if(r){const i=`level1-${r.category_level_1}`,w=`level2-${r.category_level_1}-${r.category_level_2}`;f(u=>{const p=new Set(u);return p.add(i),p.add(w),p})}}},[d,a]);const z=o.useMemo(()=>{if(!d)return null;const r=a.find(i=>i.id===d);return r?`level3-${r.category_level_1}-${r.category_level_2}-${r.category_level_3}`:null},[d,a]),b=(r,i)=>{i&&(i.stopPropagation(),i.preventDefault()),f(w=>{const u=new Set(w);return u.has(r)?u.delete(r):u.add(r),u})},S=(r,i,w,u)=>{if(u&&(u.stopPropagation(),u.preventDefault()),$){const p=`${r}/${i}/${w.name}`;$({id:w.id,level1:r,level2:i,level3:w.name,path:p})}},k=()=>x?e.jsx("div",{className:"py-8 text-center text-sm text-muted-foreground",children:"加载中..."}):!l||typeof l!="object"?e.jsx("div",{className:"py-8 text-center text-sm text-muted-foreground",children:"暂无目录数据"}):e.jsx("div",{className:"space-y-1 p-2",children:l&&l[0]&&Object.entries(l[0]).map(([r,i])=>{const w=`level1-${r}`,u=j.has(w);return e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:"flex items-center py-2 px-3 rounded cursor-pointer transition-colors hover:bg-accent",onClick:p=>b(w,p),children:[e.jsx(y,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 mr-1",onClick:p=>{p.stopPropagation(),b(w,p)},children:u?e.jsx(B,{className:"h-4 w-4"}):e.jsx(Q,{className:"h-4 w-4"})}),e.jsx(W,{className:"h-4 w-4 mr-2 text-muted-foreground"}),e.jsx("span",{className:"flex-1 truncate",children:r})]}),u&&i&&typeof i=="object"&&e.jsx("div",{className:"ml-4",children:Object.entries(i).map(([p,D])=>{const P=`level2-${r}-${p}`,T=j.has(P);return e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:"flex items-center py-2 px-3 rounded cursor-pointer transition-colors hover:bg-accent",onClick:_=>b(P,_),children:[e.jsx(y,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 mr-1",onClick:_=>{_.stopPropagation(),b(P,_)},children:T?e.jsx(B,{className:"h-4 w-4"}):e.jsx(Q,{className:"h-4 w-4"})}),e.jsx(W,{className:"h-4 w-4 mr-2 text-muted-foreground"}),e.jsx("span",{className:"flex-1 truncate",children:p})]}),T&&Array.isArray(D)&&e.jsx("div",{className:"ml-4",children:D.map(_=>{const I=`level3-${r}-${p}-${_.name}`,R=z===I;return e.jsxs("div",{className:`flex items-center py-2 px-3 rounded cursor-pointer transition-colors ${R?"bg-primary text-primary-foreground":"hover:bg-accent"}`,onClick:F=>S(r,p,_,F),children:[e.jsx("div",{className:"w-5 h-5 mr-1"}),e.jsx(W,{className:"h-4 w-4 mr-2 text-muted-foreground"}),e.jsx("span",{className:"flex-1 truncate",children:_.name})]},_.id)})})]},p)})})]},r)})});return e.jsx("div",{className:"h-full overflow-y-auto",children:k()})};_e.displayName="CatalogTree";function ne({item:l,type:a,onSave:d,onUpdateLocal:$,catalogs:x,catalogTree:j}){const{user:f}=ge(),z=me(f),b=ue(f);if(!(a==="add"&&b||(a==="edit"||a==="row_edit")&&z))return null;const[k,r]=H.useState(!1),[i,w]=H.useState(!1),[u,p]=H.useState(l?.knowledge_catalog_id||null),[D,P]=H.useState(null),[T,_]=H.useState(!1),[I,R]=H.useState(l?.knowledge_type||"qa"),F=g=>{g.key==="Enter"&&!g.shiftKey&&g.preventDefault()},t=g=>{const v=g.target.files?.[0];if(!v)return;const m=["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-excel"],C=[".xlsx",".xls"];if(!(m.includes(v.type)||C.some(O=>v.name.endsWith(O)))){c.error("仅支持 .xlsx 或 .xls 格式的 Excel 文件");return}const A=10*1024*1024;if(v.size>A){c.error("文件大小不能超过 10MB");return}P(v),c.success(`已选择文件: ${v.name}`)},h=()=>{P(null)},N=async g=>{if(!D){c.warning("请先选择 Excel 文件");return}_(!0);try{const v=await He(g,D);c.success(`Excel 上传成功，处理了 ${v.data.rows_processed} 行数据`),h()}catch(v){console.error("Excel 上传失败:",v)}finally{_(!1)}},L=H.forwardRef(({children:g,...v},m)=>e.jsx("span",{ref:m,...v,children:g}));return L.displayName="TriggerSpan",e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(fe,{open:k,onOpenChange:r,children:[e.jsx(We,{asChild:!0,children:a==="add"?e.jsxs(y,{variant:"default",children:[e.jsx(ye,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden lg:inline ml-2",children:"新增知识"})]}):a==="edit"?e.jsx(L,{className:"inline-block max-w-full cursor-pointer hover:underline truncate",title:l?.name,children:l?.name}):e.jsx("a",{type:"button",className:"w-full h-8 px-2 py-1 text-sm",children:"编辑"})}),e.jsx(ve,{className:"sm:max-w-[1400px]",onKeyDown:F,children:e.jsxs("form",{onSubmit:async g=>{g.preventDefault(),w(!0);const v=new Promise((m,C)=>{setTimeout(()=>C(new Error("请求超时，请检查网络连接")),3e4)});try{const m=new FormData(g.target),C=m.get("name"),K=m.get("type"),A=m.get("status"),O=m.get("content"),s=m.get("reference");if(a==="add"){const n=await Promise.race([qe({knowledge_type:K,knowledge_catalog_id:u||58,name:C,details:{content:O,role:"user",status:A,created_by:1,version:1,reference:s},created_by:1}),v]);console.log("response",n),c.success("知识条目创建成功")}else if(await Promise.race([pe(l.id,{knowledge_type:K,knowledge_catalog_id:u||58,name:C,details:{content:O,role:"user",status:A,created_by:l?.details?.created_by||1,version:(l?.details?.version||0)+1,reference:s}}),v]),c.success("知识条目更新成功"),K==="data_table"&&D&&await N(l.id),$){const n={id:l.id,knowledge_type:K,knowledge_catalog_id:u||58,name:C,status:A,created_at:l.created_at,updated_at:new Date().toISOString(),details:{content:O,role:"user",status:A,created_by:l?.details?.created_by||1,version:(l?.details?.version||0)+1,reference:s}};$(n)}d&&d(),r(!1)}catch(m){if(console.error("保存知识条目失败:",m),m.message==="请求超时，请检查网络连接")c.error("请求超时，请检查网络连接后重试");else if(m.response){const C=m.response.status,K=m.response.data;C===400?c.error("请求参数错误，请检查填写内容"):C===401?c.error("未授权访问，请重新登录"):C===403?c.error("权限不足，无法操作"):C===404?c.error("请求的资源不存在"):C>=500?c.error("服务器错误，请稍后重试"):c.error(K?.detail||K?.message||"请求失败"),console.error("API响应错误:",C,K)}else m.request?(c.error("网络连接失败，请检查网络设置"),console.error("网络请求错误:",m.message)):(c.error("操作失败，请重试"),console.error("其他错误:",m.message))}finally{w(!1)}},children:[e.jsxs(je,{children:[e.jsx(we,{children:a==="edit"?`编辑: ${l?.id}`:"新增"}),e.jsx(Ne,{})]}),e.jsx("div",{className:"flex gap-4 h-[720px] p-0",children:e.jsxs("div",{className:"flex gap-4 flex-1 overflow-hidden px-4",children:[e.jsxs("div",{className:"w-[300px] flex-shrink-0 border-r pr-4 overflow-hidden flex flex-col",children:[e.jsx(V,{htmlFor:"catalog",className:"mb-2",children:"知识目录"}),e.jsx("div",{className:"flex-1 overflow-auto border rounded-md",children:e.jsx(_e,{catalogTree:j||{},catalogs:x||[],selectedCatalogId:u,onCatalogSelect:g=>{p(g.id)},loading:!1})})]}),e.jsxs("div",{className:"flex-1 flex flex-col gap-2 overflow-hidden",children:[e.jsxs("div",{className:"flex-shrink-0",children:[e.jsx(V,{htmlFor:"name",className:"mb-2",children:"名称"}),e.jsx(U,{id:"name",name:"name",defaultValue:l?.name,required:!0,onKeyDown:F})]}),e.jsxs("div",{className:"h-[10%] min-h-[60px] flex gap-2 flex-shrink-0",children:[e.jsxs("div",{className:"flex-1 flex flex-col gap-2",children:[e.jsx(V,{htmlFor:"type",children:"类型"}),e.jsxs(G,{name:"type",value:I,onValueChange:g=>R(g),children:[e.jsx(Y,{id:"type",className:"w-full",children:e.jsx(Z,{placeholder:"选择类型"})}),e.jsxs(J,{children:[e.jsx(M,{value:"qa",children:"问答"}),e.jsx(M,{value:"document",children:"文档"}),e.jsx(M,{value:"data_table",children:"数据表"})]})]})]}),e.jsxs("div",{className:"flex-1 flex flex-col gap-2",children:[e.jsx(V,{htmlFor:"status",children:"状态"}),e.jsxs(G,{name:"status",defaultValue:l?.status||"pending",children:[e.jsx(Y,{id:"status",className:"w-full",children:e.jsx(Z,{placeholder:"选择状态"})}),e.jsxs(J,{children:[e.jsx(M,{value:"active",children:"已启用"}),e.jsx(M,{value:"pending",children:"待审核"})]})]})]}),I==="data_table"&&e.jsxs("div",{className:"flex-shrink-0 border rounded-md p-3 bg-muted/30",children:[e.jsxs(V,{className:"mb-2 flex items-center gap-2",children:[e.jsx(de,{className:"h-4 w-4"}),"Excel 数据上传"]}),D?e.jsxs("div",{className:"flex items-center justify-between p-2 bg-background rounded-md border",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[e.jsx(de,{className:"h-4 w-4 text-green-600 flex-shrink-0"}),e.jsx("span",{className:"text-sm truncate",children:D.name})]}),e.jsx(y,{type:"button",variant:"ghost",size:"sm",onClick:h,disabled:T,children:e.jsx(js,{className:"h-4 w-4"})})]}):e.jsx(U,{type:"file",accept:".xlsx,.xls",onChange:t,disabled:T})]})]}),e.jsxs("div",{className:"h-[60%] flex flex-col flex-shrink-0",children:[e.jsx(V,{htmlFor:"content",className:"mb-2",children:"内容"}),e.jsx("div",{className:"flex-1 min-h-0",children:e.jsx(oe,{id:"content",name:"content",placeholder:"请输入内容",defaultValue:l?.details?.content,className:"h-full w-full resize-none",required:!0,onKeyDown:F})})]}),e.jsxs("div",{className:"h-[15%] min-h-[80px] flex flex-col flex-shrink-0",children:[e.jsx(V,{htmlFor:"reference",className:"mb-2",children:"参考资料"}),e.jsx("div",{className:"flex-1 min-h-0",children:e.jsx(oe,{id:"reference",name:"reference",placeholder:"请输入参考资料链接或标识",defaultValue:l?.details?.reference||"",className:"h-full w-full resize-none",onKeyDown:F})})]})]})]})}),e.jsx(Xe,{className:"px-4 py-4 border-t",children:e.jsxs("div",{className:"flex justify-end gap-4 w-full",children:[e.jsx("div",{className:"w-24",children:e.jsx(Ge,{asChild:!0,children:e.jsx(y,{variant:"outline",className:"w-full",type:"button",children:"取消"})})}),e.jsx("div",{className:"w-24",children:e.jsx(y,{type:"submit",className:"w-full",disabled:i,children:i?"保存中...":"保存"})})]})})]})})]})})}function ws({content:l}){const[a,d]=o.useState(!1);return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:e.jsxs(ze,{children:[e.jsx(De,{asChild:!0,children:e.jsx("a",{className:"text-md line-clamp-3 leading-relaxed whitespace-normal break-words cursor-help text-xs text-muted-foreground",children:l})}),e.jsx(Ke,{side:"top",className:"max-w-sm",children:e.jsx("span",{className:"text-xl leading-relaxed whitespace-pre-wrap",children:l})})]})}),e.jsx(es,{direction:"right",open:a,onOpenChange:d,children:e.jsxs(ss,{children:[e.jsx(as,{children:e.jsx(ls,{children:"内容详情"})}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:e.jsx("pre",{className:"whitespace-pre-wrap break-words font-sans",children:l})}),e.jsx(ts,{children:e.jsx(ns,{asChild:!0,children:e.jsx(y,{variant:"outline",children:"关闭"})})})]})})]})}async function be(){try{return(await ee.get("/v1/admin/knowledge/catalog-tree")).data}catch(l){throw c.error(l.message||"Failed to fetch knowledge catalog tree"),l}}async function ke(){try{return(await ee.get("/v1/admin/knowledge/catalogs")).data}catch(l){throw c.error(l.message||"Failed to fetch knowledge catalogs"),l}}async function Ns(l){try{const a=await ee.post("/v1/admin/knowledge/catalogs",l);return c.success("保存成功"),a.data}catch(a){throw c.error(a.message||"Failed to create knowledge catalog"),a}}async function ys(l,a){try{const d=await ee.put(`/v1/admin/knowledge/catalogs/${l}`,a);return c.success("Knowledge catalog updated successfully"),d.data}catch(d){throw c.error(d.message||"Failed to update knowledge catalog"),d}}async function _s(l){try{const a=await ee.delete(`/v1/admin/knowledge/catalogs/${l}`);return c.success("Knowledge catalog deleted successfully"),a.data}catch(a){throw c.error(a.message||"Failed to delete knowledge catalog"),a}}function bs(){const[l,a]=o.useState(!1),[d,$]=o.useState(!1),[x,j]=o.useState({items:[],total:0,page:1,size:10,has_next:!1,has_prev:!1}),[f,z]=o.useState({name:"",knowledge_type:"qa",status:"all",orderby:"id",order:"desc",page:1,size:10}),[b,S]=o.useState(null),[k,r]=o.useState([]),[i,w]=o.useState({}),u=o.useCallback(async(t=!1)=>{if(!t&&k.length>0)return k;$(!0);try{const[h,N]=await Promise.all([ke(),be()]);return r(h),w(N),h}catch(h){return console.error("获取目录数据失败:",h),c.error("获取目录数据失败"),[]}finally{$(!1)}},[k.length]),p=o.useCallback(async()=>{a(!0);try{const t=await Be({page:f.page,size:f.size,catalog_level_1:b?.level1||void 0,catalog_level_2:b?.level2||void 0,catalog_level_3:b?.level3||void 0,knowledge_type:f.knowledge_type!=="all"?f.knowledge_type:void 0,name:f.name||void 0,status:f.status&&f.status!=="all"?f.status:void 0,orderby:f.orderby,order:f.order});j(t)}catch(t){console.error("获取知识条目失败:",t),c.error("获取知识条目失败"),j({items:[],total:0,page:1,size:10,has_next:!1,has_prev:!1})}finally{a(!1)}},[f,b]),D=o.useCallback(t=>{S(t),z(h=>({...h,page:1}))},[]),P=o.useCallback((t,h,N,L,g)=>{z(v=>({...v,name:t!==void 0?t:v.name,knowledge_type:h!==void 0?h:v.knowledge_type,status:N!==void 0?N:v.status,orderby:L??v.orderby,order:g??v.order,page:1}))},[]),T=o.useCallback(()=>{z({name:"",knowledge_type:"all",status:"all",orderby:"id",order:"desc",page:1,size:10}),S(null)},[]),_=o.useCallback(t=>{z(h=>({...h,page:t}))},[]),I=o.useCallback(t=>{z(h=>({...h,page:1,size:t}))},[]);o.useEffect(()=>{u()},[]),o.useEffect(()=>{p()},[p]);const R=o.useCallback(async()=>{await u(!0)},[u]),F=o.useCallback(t=>{!t||!t.id||j(h=>({...h,items:h.items.map(N=>N.id===t.id?{...N,...t}:N)}))},[]);return{knowledgeData:x,catalogs:k,catalogTree:i,selectedCatalog:b,searchParams:f,loading:l,catalogsLoading:d,handleCatalogSelect:D,handleSearch:P,handleReset:T,handlePageChange:_,handlePageSizeChange:I,refreshCatalogs:R,updateLocalKnowledgeEntry:F}}const ks={qa:"问答",document:"文档",data_table:"数据表"},xe={active:{label:"已启用",icon:rs,color:"text-green-500"},pending:{label:"待审核",icon:Ye,color:"text-yellow-500"},deleted:{label:"已删除",icon:null,color:"text-gray-400"}},he=l=>new Date(l).toLocaleDateString("zh-CN");function Cs({data:l,pagination:a,selectedCatalog:d,loading:$,searchParams:x,onSearch:j,onReset:f,onPageChange:z,onPageSizeChange:b,onUpdateLocal:S}){const{user:k}=ge(),r=me(k),i=Ue(k),w=ue(k),[u,p]=o.useState([]),[D,P]=o.useState({});o.useEffect(()=>{(async()=>{try{const[n,E]=await Promise.all([ke(),be()]);p(n),P(E)}catch(n){console.error("加载目录数据失败:",n)}})()},[]);const T=[{id:"select",header:({table:s})=>e.jsx("input",{type:"checkbox",checked:s.getIsAllPageRowsSelected(),onChange:n=>s.toggleAllPageRowsSelected(!!n.target.checked),"aria-label":"Select all"}),cell:({row:s})=>e.jsx("input",{type:"checkbox",checked:s.getIsSelected(),onChange:n=>s.toggleSelected(!!n.target.checked),"aria-label":"Select row"}),enableSorting:!1,enableHiding:!1,size:50},{id:"id",accessorKey:"id",header:({column:s})=>{const n=s.getIsSorted();return e.jsxs("div",{className:"flex items-center gap-1 cursor-pointer select-none",onClick:()=>s.toggleSorting(),children:[e.jsx("span",{className:"text-muted-foreground",children:"ID"}),n==="asc"&&e.jsx(te,{className:"size-3"}),n==="desc"&&e.jsx(B,{className:"size-3"})]})},cell:({row:s})=>e.jsx("div",{className:"truncate break-words leading-tight",children:s.original.id}),enableSorting:!0,enableHiding:!1,size:80},{accessorKey:"name",header:"知识名称",cell:({row:s})=>r?e.jsx(ne,{item:s.original,type:"edit",catalogs:u,catalogTree:D,onUpdateLocal:S}):e.jsx("span",{className:"truncate break-words leading-tight",title:s.original.name,children:s.original.name}),enableHiding:!0,size:300},{accessorKey:"knowledge_type",header:"类型",cell:({row:s})=>e.jsx(ce,{variant:"outline",className:"px-1.5 text-muted-foreground",children:ks[s.original.knowledge_type]??"-"}),size:60},{accessorKey:"details",header:"内容",cell:({row:s})=>s.original.details?.content?e.jsx(ws,{content:s.original.details.content}):e.jsx("span",{className:"text-muted-foreground",children:"暂无内容"}),size:400},{accessorKey:"status",header:"状态",cell:({row:s})=>{const n=xe[s.original.status]??xe.deleted,E=n.icon;return e.jsxs(ce,{variant:"outline",className:"gap-1 px-1.5 text-muted-foreground",children:[E&&e.jsx(E,{className:`size-3 ${n.color}`}),e.jsx("span",{children:n.label})]})},size:60},{accessorKey:"created_at",header:({column:s})=>{const n=s.getIsSorted();return e.jsxs("div",{className:"flex items-center gap-1 cursor-pointer select-none",onClick:()=>s.toggleSorting(),children:[e.jsx("span",{children:"创建时间"}),n==="asc"&&e.jsx(te,{className:"size-3"}),n==="desc"&&e.jsx(B,{className:"size-3"})]})},cell:({row:s})=>e.jsx("span",{className:"text-muted-foreground",children:he(s.original.created_at)}),sortingFn:"datetime",enableSorting:!0,size:100},{accessorKey:"updated_at",header:({column:s})=>{const n=s.getIsSorted();return e.jsxs("div",{className:"flex items-center gap-1 cursor-pointer select-none",onClick:()=>s.toggleSorting(),children:[e.jsx("span",{children:"更新时间"}),n==="asc"&&e.jsx(te,{className:"size-3"}),n==="desc"&&e.jsx(B,{className:"size-3"})]})},cell:({row:s})=>e.jsx("span",{className:"text-muted-foreground",children:he(s.original.updated_at)}),sortingFn:"datetime",enableSorting:!0,size:100},{id:"actions",cell:({row:s})=>r||i?e.jsxs(Te,{children:[e.jsx(Ee,{asChild:!0,children:e.jsx(y,{variant:"ghost",size:"icon",className:"size-8 text-muted-foreground",children:e.jsx(Me,{})})}),e.jsxs(Fe,{align:"end",className:"w-32",children:[r&&e.jsx(ne,{item:s.original,type:"row_edit",catalogs:u,catalogTree:D,onUpdateLocal:S}),r&&i&&e.jsx(Pe,{}),i&&e.jsx(Ie,{className:"text-destructive text-center",onClick:()=>A(s.original),children:"删除"})]})]}):null,size:60}],[_,I]=o.useState(x.name),[R,F]=o.useState(x.knowledge_type),[t,h]=o.useState(x.status||"all");o.useEffect(()=>{I(x.name),F(x.knowledge_type),h(x.status||"all")},[x]);const[N,L]=o.useState({}),[g,v]=o.useState([{id:"id",desc:!0}]),m=Re({data:l,columns:T,state:{rowSelection:N,sorting:g},enableRowSelection:!0,onRowSelectionChange:L,onSortingChange:s=>{const n=typeof s=="function"?s(g):s;if(v(n),n&&n.length>0){const{id:E,desc:q}=n[0],se=E,Se=q?"desc":"asc";j(x.name??void 0,x.knowledge_type??void 0,x.status??void 0,se,Se)}else j(x.name??void 0,x.knowledge_type??void 0,x.status??void 0,"id","desc")},getCoreRowModel:Oe(),getFilteredRowModel:Ve(),getPaginationRowModel:Ae(),getSortedRowModel:Le()}),C=()=>j(_??void 0,R??void 0,t),K=s=>s.key==="Enter"&&C(),A=async s=>{const n=new Promise((E,q)=>{setTimeout(()=>q(new Error("请求超时，请检查网络连接")),3e4)});try{await Promise.race([pe(s.id,{knowledge_type:s.knowledge_type,knowledge_catalog_id:s.knowledge_catalog_id,name:s.name,details:{...s.details,status:"deleted"}}),n]),c.success("知识条目已删除")}catch(E){if(console.error("删除知识条目失败:",E),f&&f(),E.message==="请求超时，请检查网络连接")c.error("请求超时，请检查网络连接后重试");else if(E.response){const q=E.response.status,se=E.response.data;q===400?c.error("请求参数错误"):q===401?c.error("未授权访问，请重新登录"):q===403?c.error("权限不足，无法操作"):q===404?c.error("请求的资源不存在"):q>=500?c.error("服务器错误，请稍后重试"):c.error(se?.detail||se?.message||"删除失败")}else E.request?c.error("网络连接失败，请检查网络设置"):c.error("删除失败，请重试")}},O=Math.ceil(a.total/a.size);return e.jsxs("div",{className:"w-full h-full flex flex-col gap-6",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 lg:px-6 py-2",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:d?[d.level1,d.level2,d.level3].filter(Boolean).join(" / "):"全部知识"}),e.jsxs("div",{className:"w-2/3 flex items-center gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx($e,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),e.jsx(U,{placeholder:"搜索知识名称...",className:"pl-10",value:_,onChange:s=>I(s.target.value),onKeyDown:K})]}),e.jsxs(G,{value:R,onValueChange:s=>{F(s),j(_??void 0,s,t)},children:[e.jsx(Y,{className:"w-32",children:e.jsx(Z,{placeholder:"类型"})}),e.jsxs(J,{children:[e.jsx(M,{value:"all",children:"全部类型"}),e.jsx(M,{value:"qa",children:"问答"}),e.jsx(M,{value:"document",children:"文档"}),e.jsx(M,{value:"data_table",children:"数据表"})]})]}),e.jsxs(G,{value:t,onValueChange:s=>{h(s),j(_??void 0,R??void 0,s)},children:[e.jsx(Y,{className:"w-32",children:e.jsx(Z,{placeholder:"状态"})}),e.jsxs(J,{children:[e.jsx(M,{value:"all",children:"全部状态"}),e.jsx(M,{value:"active",children:"已启用"}),e.jsx(M,{value:"pending",children:"待审核"}),e.jsx(M,{value:"deleted",children:"已删除"})]})]}),e.jsx(y,{onClick:C,children:"搜索"}),e.jsx(y,{variant:"outline",onClick:f,children:"重置"}),w&&e.jsx(ne,{type:"add",catalogs:u,catalogTree:D,item:{name:""},onSave:f})]})]}),e.jsx("div",{className:"flex-1 flex flex-col overflow-hidden",children:e.jsxs("div",{className:"overflow-hidden rounded-lg border flex-1 flex flex-col",children:[e.jsx("div",{className:"overflow-hidden",children:e.jsxs(ie,{className:"w-full table-fixed",children:[e.jsx("colgroup",{children:T.map((s,n)=>e.jsx("col",{style:{width:s.size}},n))}),e.jsx(cs,{className:"bg-muted",children:m.getHeaderGroups().map(s=>e.jsx(ae,{children:s.headers.map(n=>e.jsx(os,{colSpan:n.colSpan,className:"align-middle",children:n.isPlaceholder?null:re(n.column.columnDef.header,n.getContext())},n.id))},s.id))})]})}),e.jsx("div",{className:"overflow-auto flex-1",children:e.jsxs(ie,{className:"w-full table-fixed",children:[e.jsx("colgroup",{children:T.map((s,n)=>e.jsx("col",{style:{width:s.size}},n))}),e.jsx(is,{children:$?e.jsx(ae,{children:e.jsx(le,{colSpan:T.length,className:"h-24 text-center",children:"加载中..."})}):m.getRowModel().rows.length?m.getRowModel().rows.map(s=>e.jsx(ae,{"data-state":s.getIsSelected()&&"selected",children:s.getVisibleCells().map(n=>e.jsx(le,{className:"align-middle py-2",children:re(n.column.columnDef.cell,n.getContext())},n.id))},s.id)):e.jsx(ae,{children:e.jsx(le,{colSpan:T.length,className:"h-24 text-center",children:"无数据"})})})]})}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-2 border-t shrink-0",children:[e.jsxs("div",{className:"text-muted-foreground hidden flex-1 text-sm lg:flex",children:["共 ",a.total," 条数据"]}),e.jsxs("div",{className:"flex w-full items-center gap-8 lg:w-fit",children:[e.jsxs("div",{className:"hidden items-center gap-2 lg:flex",children:[e.jsx(V,{htmlFor:"rows-per-page",className:"text-sm font-medium",children:"每页行数"}),e.jsxs(G,{value:`${x.size}`,onValueChange:s=>{b(Number(s)),m.setPageSize(Number(s))},children:[e.jsx(Y,{className:"w-20",size:"sm",id:"rows-per-page",children:e.jsx(Z,{})}),e.jsx(J,{side:"top",children:[10,20,30,40,50,100,500,1e3].map(s=>e.jsx(M,{value:`${s}`,children:s},s))})]})]}),e.jsxs("div",{className:"text-sm font-medium",children:["第 ",a.page," 页，共 ",O," 页"]}),e.jsxs("div",{className:"ml-auto flex items-center gap-2 lg:ml-0",children:[e.jsx(y,{variant:"outline",className:"hidden lg:flex size-8",size:"icon",onClick:()=>z(1),disabled:a.page<=1,children:e.jsx(Ze,{className:"size-4"})}),e.jsx(y,{variant:"outline",className:"size-8",size:"icon",onClick:()=>z(a.page-1),disabled:a.page<=1,children:e.jsx(Je,{className:"size-4"})}),e.jsx(y,{variant:"outline",className:"size-8",size:"icon",onClick:()=>z(a.page+1),disabled:!a.hasNext,children:e.jsx(Q,{className:"size-4"})}),e.jsx(y,{variant:"outline",className:"hidden lg:flex size-8",size:"icon",onClick:()=>z(O),disabled:!a.hasNext||a.page>=O,children:e.jsx(Qe,{className:"size-4"})})]})]})]})]})})]})}const Ss=({dialogType:l,formData:a,onChange:d,onSave:$,onCancel:x})=>e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(V,{htmlFor:"level1",className:"text-right",children:"一级目录 *"}),e.jsx(U,{id:"level1",value:a.catalog_level_1,onChange:j=>d({id:a.id,name:a.name,catalog_level_1:j.target.value,catalog_level_2:a.catalog_level_2,catalog_level_3:a.catalog_level_3}),className:"col-span-3",placeholder:"请输入一级目录名称"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(V,{htmlFor:"level2",className:"text-right",children:"二级目录 *"}),e.jsx(U,{id:"level2",value:a.catalog_level_2,onChange:j=>d({id:a.id,name:a.name,catalog_level_1:a.catalog_level_1,catalog_level_2:j.target.value,catalog_level_3:a.catalog_level_3}),className:"col-span-3",placeholder:"请输入二级目录名称"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(V,{htmlFor:"level3",className:"text-right",children:"三级目录 *"}),e.jsx(U,{id:"level3",value:a.catalog_level_3,onChange:j=>d({id:a.id,name:a.name,catalog_level_1:a.catalog_level_1,catalog_level_2:a.catalog_level_2,catalog_level_3:j.target.value}),className:"col-span-3",placeholder:"请输入三级目录名称"})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[x&&e.jsx(y,{variant:"outline",onClick:x,children:"取消"}),e.jsx(y,{onClick:$,children:l==="edit"?"更新目录":"创建目录"})]})]}),Ce=({catalogTree:l,catalogs:a,loading:d,onCatalogSelect:$,onCatalogRefresh:x})=>{const[j,f]=o.useState(new Set(["root"])),[z,b]=o.useState(!1),[S,k]=o.useState({id:0,name:"",catalog_level_1:"",catalog_level_2:"",catalog_level_3:""}),[r,i]=o.useState(null),[w,u]=o.useState(null),p=t=>{f(h=>{const N=new Set(h);return N.has(t)?N.delete(t):N.add(t),N})},D=(t,h,N,L)=>{u(L),$({level1:t,level2:h,level3:N})},P=()=>{u(null),$(null)},T=()=>d?e.jsx("div",{className:"py-2 text-center text-sm text-muted-foreground",children:"加载中..."}):!l||typeof l!="object"?e.jsx("div",{className:"py-2 text-center text-sm text-muted-foreground",children:"暂无目录数据"}):e.jsxs("div",{className:"space-y-1 p-2",children:[e.jsx("div",{className:`flex items-center py-1 px-2 rounded cursor-pointer ${w==="all"?"bg-primary/10":"hover:bg-accent"}`,onClick:P,children:e.jsx("span",{className:"ml-1",children:"全部知识"})}),l&&l[0]&&Object.entries(l[0]).map(([t,h])=>{const N=`level1-${t}`,L=j.has(N);return e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:`flex items-center py-1 px-2 rounded cursor-pointer ${w===N?"bg-primary/10":"hover:bg-accent"}`,onClick:()=>{p(N),D(t,"","",N)},children:[e.jsx(y,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 mr-1",onClick:g=>{g.stopPropagation(),p(N)},children:L?e.jsx(B,{className:"h-4 w-4"}):e.jsx(Q,{className:"h-4 w-4"})}),e.jsx(W,{className:"h-4 w-4 mr-2 text-muted-foreground"}),e.jsx("span",{className:"flex-1 truncate",children:t})]}),L&&h&&typeof h=="object"&&e.jsx("div",{className:"ml-4",children:Object.entries(h).map(([g,v])=>{const m=`level2-${t}-${g}`,C=j.has(m);return e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:`flex items-center py-1 px-2 rounded cursor-pointer ${w===m?"bg-primary/10":"hover:bg-accent"}`,onClick:()=>{p(m),D(t,g,"",m)},children:[e.jsx(y,{variant:"ghost",size:"sm",className:"h-5 w-5 p-0 mr-1",onClick:K=>{K.stopPropagation(),p(m)},children:C?e.jsx(B,{className:"h-4 w-4"}):e.jsx(Q,{className:"h-4 w-4"})}),e.jsx(W,{className:"h-4 w-4 mr-2 text-muted-foreground"}),e.jsx("span",{className:"flex-1 truncate",children:g})]}),C&&Array.isArray(v)&&e.jsx("div",{className:"ml-4",children:v.map(K=>{const A=`level3-${t}-${g}-${K.name}`;return e.jsxs("div",{className:`flex items-center py-1 px-2 rounded cursor-pointer ${w===A?"bg-primary/10":"hover:bg-accent"}`,onClick:()=>D(t,g,K.name,A),children:[e.jsx("div",{className:"w-5 h-5 mr-1"}),e.jsx(W,{className:"h-4 w-4 mr-2 text-muted-foreground"}),e.jsx("span",{className:"flex-1 truncate",children:K.name})]},K.id)})})]},g)})})]},t)})]}),_=t=>{i("edit"),k({id:t.id,name:t.category_level_3,catalog_level_1:t.category_level_1,catalog_level_2:t.category_level_2,catalog_level_3:t.category_level_3}),b(!0)},I=()=>{k({id:-1,name:"",catalog_level_1:"",catalog_level_2:"",catalog_level_3:""}),b(!0)},R=async()=>{if(!S.catalog_level_1||!S.catalog_level_2||!S.catalog_level_3){c.error("请填写完整的一级、二级和三级目录");return}try{r==="add"?(await Ns(S),c.success("目录创建成功")):r==="edit"&&(await ys(S.id,S),c.success("目录更新成功"))}catch{c.error("操作失败");return}x&&await x(),i(null)},F=async()=>{try{await _s(S.id),c.success("目录删除成功")}catch{c.error("删除失败");return}x&&await x(),i(null)};return e.jsxs("div",{className:"h-full flex flex-col border rounded-xl overflow-hidden",children:[e.jsx("div",{className:"border-b px-4 py-2 flex items-center justify-between",children:e.jsx("div",{className:"w-full",children:e.jsxs(y,{variant:"ghost",size:"sm",className:"w-full justify-start",onClick:I,children:[e.jsx(gs,{className:"h-4 w-4 mr-2"}),"管理目录"]})})}),e.jsx(ds,{className:"flex-1 p-0 overflow-auto",children:e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsx("div",{className:"flex-1 overflow-y-auto",children:T()}),e.jsx(fe,{open:z,onOpenChange:b,children:e.jsxs(ve,{className:"sm:max-w-[900px] p-8",children:[e.jsxs(je,{className:"flex flex-row items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(we,{children:r==="edit"?"编辑目录":"管理目录"}),e.jsx(Ne,{children:r==="edit"?"修改目录信息，点击保存更新目录":"管理所有知识库目录，可以新增、编辑或删除目录"})]}),r?null:e.jsxs(y,{variant:"default",size:"sm",onClick:()=>{i("add"),k({id:-1,name:"",catalog_level_1:"",catalog_level_2:"",catalog_level_3:""})},children:[e.jsx(ye,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden lg:inline ml-2",children:"知识目录"})]})]}),r?e.jsx(Ss,{dialogType:r,formData:S,onChange:k,onSave:R,onCancel:()=>i(null)}):e.jsxs("div",{className:"max-h-120",children:[e.jsxs("div",{className:"grid grid-cols-4 gap-2 py-2 font-semibold border-b",children:[e.jsx("div",{children:"一级目录"}),e.jsx("div",{children:"二级目录"}),e.jsx("div",{children:"三级目录"}),e.jsx("div",{className:"text-right",children:"操作"})]}),e.jsx("div",{className:"max-h-96 overflow-y-auto",children:a.map(t=>e.jsxs("div",{className:"grid grid-cols-4 gap-2 py-2 border-b",children:[e.jsx("div",{className:"truncate",title:t.category_level_1,children:t.category_level_1}),e.jsx("div",{className:"truncate",title:t.category_level_2,children:t.category_level_2}),e.jsx("div",{className:"truncate",title:t.category_level_3,children:t.category_level_3}),e.jsxs("div",{className:"flex justify-end gap-1",children:[e.jsx(y,{size:"sm",variant:"outline",onClick:()=>_(t),children:"编辑"}),e.jsx(y,{size:"sm",variant:"destructive",onClick:()=>{k({id:t.id,name:t.category_level_3,catalog_level_1:t.category_level_1,catalog_level_2:t.category_level_2,catalog_level_3:t.category_level_3}),F()},children:e.jsx(fs,{className:"h-4 w-4"})})]})]},t.id))}),a.length===0&&e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"暂无目录数据"})]})]})})]})})]})};Ce.displayName="KnowledgeCatalogComp";function qs(){const{knowledgeData:l,catalogs:a,catalogTree:d,selectedCatalog:$,searchParams:x,loading:j,catalogsLoading:f,handleCatalogSelect:z,handleSearch:b,handleReset:S,handlePageChange:k,handlePageSizeChange:r,refreshCatalogs:i,updateLocalKnowledgeEntry:w}=bs();return e.jsxs("div",{className:"flex gap-2 h-full",children:[e.jsx("div",{className:"w-1/6 min-w-[200px] max-h-[540px] flex flex-col",children:e.jsx(Ce,{catalogTree:d,catalogs:a,loading:f,onCatalogSelect:z,onCatalogRefresh:i})}),e.jsx("div",{className:"flex-1 flex flex-col h-full",children:e.jsx(Cs,{data:l.items,pagination:{total:l.total,page:l.page,size:l.size,hasNext:l.has_next,hasPrev:l.has_prev},selectedCatalog:$,loading:j,searchParams:x,onSearch:b,onReset:S,onPageChange:k,onPageSizeChange:r,onUpdateLocal:w})})]})}export{qs as default};
