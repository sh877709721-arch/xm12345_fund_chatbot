import{z as U,R as n,t as c,j as e,B as N,r as C,s as W}from"./index-BkZ1fbvE.js";import{g as X,s as Y}from"./search-C9nUSLrd.js";import{C as Z,a as $,b as ee,e as se}from"./card-CXEOfyPU.js";import{B as x}from"./badge-D8rsmH0n.js";import{D as ae,a as te,b as le,c as re,d as ne,e as ie,f as ce,g as de}from"./dialog-DdHcYUWU.js";import{L as D}from"./label-BPYBCH7t.js";import{S as H,a as O,b as A,c as M,d as j}from"./select-BVe2FuYJ.js";import{T as Q}from"./textarea-DZUYYOaG.js";import{c as oe,u as xe}from"./permission-3MV1YRl5.js";import{L as I}from"./loader-circle-qc_e4yNT.js";import{S as he}from"./square-pen-DQXwvMiz.js";import{S as G}from"./search-CLI9qL7o.js";import"./index-BdQq_4o_.js";import"./index-JW4qzHJT.js";function me({knowledgeId:r,title:m,type:a,onSave:K,trigger:u}){const{user:y}=U(),o=oe(y),[f,g]=n.useState(!1),[b,h]=n.useState(!1),[s,p]=n.useState(null),[E,w]=n.useState(!1),[i,v]=n.useState(!1),[L,S]=n.useState(""),[R,_]=n.useState(""),[k,q]=n.useState("active"),[P,z]=n.useState("qa"),T=n.useCallback(async()=>{if(r){w(!0);try{const t=await X(r);if(t.length>0){const l=t[0];p(l),S(l.content),_(l.reference),q(l.status),z(a==="qa"?"qa":"document")}}catch(t){console.error("加载知识详情失败:",t),c.error("加载知识详情失败")}finally{w(!1)}}},[r,a]);n.useEffect(()=>{f&&(T(),o||v(!1))},[f,T,o]);const J=async()=>{if(!s||!r)return;h(!0);const t=new Promise((l,d)=>{setTimeout(()=>d(new Error("请求超时，请检查网络连接")),3e4)});try{await Promise.race([xe(r,{knowledge_type:P,knowledge_catalog_id:0,name:m,details:{content:L,role:s.role,status:k,version:s.version+1,reference:R}}),t]),c.success("知识条目已更新"),v(!1),await T(),K?.()}catch(l){if(console.error("更新知识条目失败:",l),l.message==="请求超时，请检查网络连接")c.error("请求超时，请检查网络连接后重试");else if(l.response){const d=l.response.status,V=l.response.data;d===400?c.error("请求参数错误"):d===401?c.error("未授权访问，请重新登录"):d===403?c.error("权限不足，无法操作"):d===404?c.error("请求的资源不存在"):d>=500?c.error("服务器错误，请稍后重试"):c.error(V?.detail||V?.message||"更新失败")}else l.request?c.error("网络连接失败，请检查网络设置"):c.error("更新失败，请重试")}finally{h(!1)}},B=n.forwardRef(({children:t,...l},d)=>e.jsx("span",{ref:d,...l,className:"inline-block max-w-full cursor-pointer hover:underline truncate",children:t}));B.displayName="TriggerSpan";const F=t=>{t.key==="Enter"&&!t.shiftKey&&t.preventDefault()};return e.jsxs(ae,{open:f,onOpenChange:g,children:[e.jsx(te,{asChild:!0,children:u||e.jsxs(B,{title:m,children:[r,":",m]})}),e.jsx(le,{className:"sm:max-w-[700px]",onKeyDown:F,children:e.jsxs("div",{className:"flex flex-col h-[600px]",children:[e.jsxs(re,{className:"px-6 pt-6 pb-4 border-b",children:[e.jsxs(ne,{className:"flex items-center justify-between",children:[e.jsx("span",{children:m}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(x,{variant:"outline",className:"text-xs",children:["ID: ",r]}),e.jsx(x,{variant:"secondary",className:"text-xs",children:a==="qa"?"问答":"文档"})]})]}),e.jsx(ie,{children:"知识详情内容查看和编辑"})]}),e.jsx("div",{className:"flex-1 overflow-hidden px-6 py-4",children:E?e.jsxs("div",{className:"flex items-center justify-center h-full",children:[e.jsx(I,{className:"w-6 h-6 animate-spin"}),e.jsx("span",{className:"ml-2",children:"加载中..."})]}):s?e.jsxs("div",{className:"flex flex-col gap-4 h-full",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(D,{htmlFor:"status",children:"状态:"}),e.jsxs(H,{value:k,onValueChange:q,disabled:!i,children:[e.jsx(O,{className:"w-32",id:"status",children:e.jsx(A,{})}),e.jsxs(M,{children:[e.jsx(j,{value:"active",children:"已启用"}),e.jsx(j,{value:"pending",children:"待审核"}),e.jsx(j,{value:"deleted",children:"已删除"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(D,{htmlFor:"type",children:"类型:"}),e.jsxs(H,{value:P,onValueChange:t=>z(t),disabled:!i,children:[e.jsx(O,{className:"w-32",id:"type",children:e.jsx(A,{})}),e.jsxs(M,{children:[e.jsx(j,{value:"qa",children:"问答"}),e.jsx(j,{value:"document",children:"文档"}),e.jsx(j,{value:"data_table",children:"数据表"})]})]})]})]}),o&&e.jsx(N,{variant:"outline",size:"sm",onClick:()=>{i?(S(s.content),_(s.reference),q(s.status),v(!1)):v(!0)},children:i?"取消":e.jsx(he,{className:"w-4 h-4"})})]}),e.jsx("div",{className:"flex-1 flex flex-col gap-4 min-h-0 overflow-auto",children:e.jsxs("div",{className:"flex-1 flex flex-col gap-2",children:[e.jsx(D,{htmlFor:"content",children:"内容"}),e.jsx("div",{className:"flex-1 min-h-0",children:e.jsx(Q,{id:"content",value:L,onChange:t=>S(t.target.value),disabled:!i,className:"h-full w-full resize-none",placeholder:"请输入内容",onKeyDown:F})})]})}),e.jsxs("div",{className:"flex-1 flex flex-col gap-4 min-h-0 overflow-auto",children:[e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx(D,{htmlFor:"reference",children:"参考资料"}),e.jsx(Q,{id:"reference",value:R,onChange:t=>_(t.target.value),disabled:!i,placeholder:"请输入参考资料链接或标识",onKeyDown:F})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm text-muted-foreground",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"版本:"})," ",s.version]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"创建时间:"})," ",new Date(s.created_at).toLocaleString("zh-CN")]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"更新时间:"})," ",new Date(s.updated_at).toLocaleString("zh-CN")]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"角色:"})," ",s.role]})]})]})]}):e.jsx("div",{className:"flex items-center justify-center h-full text-muted-foreground",children:"无法加载知识详情"})}),e.jsx(ce,{className:"px-6 py-4 border-t",children:e.jsxs("div",{className:"flex justify-end gap-3 w-full",children:[!i&&e.jsx(de,{asChild:!0,children:e.jsx(N,{variant:"outline",children:"关闭"})}),o&&i&&s&&e.jsxs(e.Fragment,{children:[e.jsx(N,{variant:"outline",onClick:()=>{S(s.content),_(s.reference),q(s.status),v(!1)},children:"取消"}),e.jsx(N,{onClick:J,disabled:b,children:b?"保存中...":"保存"})]})]})})]})})]})}function De(){const[r,m]=C.useState(""),[a,K]=C.useState(),[u,y]=C.useState(!1),[o,f]=C.useState(null),g=async()=>{if(r.trim()){y(!0),f(null);try{const s={query:r.trim()},p=await Y(s);K(p)}catch{f("搜索失败，请重试")}finally{y(!1)}}},b=s=>{s.key==="Enter"&&g()},h=({id:s,title:p,content:E,score:w,type:i})=>e.jsxs(Z,{className:"h-[320h] w-full",children:[e.jsx($,{children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsx(ee,{className:"text-lg font-medium leading-tight",children:e.jsx(me,{knowledgeId:s,title:p,type:i,onSave:g})}),e.jsx(x,{variant:"secondary",className:"text-xs",children:i==="qa"?"问答":"文档"})]})}),e.jsxs(se,{className:"pt-0",children:[e.jsx("p",{className:"text-sm text-muted-foreground leading-relaxed",children:E}),e.jsx("div",{className:"mt-3 flex items-center justify-between",children:e.jsxs(x,{variant:"outline",className:"text-xs",children:["匹配度: ",parseFloat(w).toFixed(2)]})})]})]});return e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx(W,{placeholder:"请输入搜索关键词...",value:r,onChange:s=>m(s.target.value),onKeyDown:b,className:"flex-1"}),e.jsxs(N,{onClick:g,disabled:u||!r.trim(),className:"px-6",children:[u?e.jsx(I,{className:"w-4 h-4 animate-spin"}):e.jsx(G,{className:"w-4 h-4"}),e.jsx("span",{className:"ml-2",children:"搜索"})]})]}),o&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsx("p",{className:"text-red-600 text-sm",children:o})}),a&&e.jsxs("div",{className:"max-h-[calc(100vh-200px)] overflow-y-auto grid grid-cols-1 lg:grid-cols-1 gap-6 mx-auto",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"精确匹配"}),e.jsxs(x,{variant:"outline",children:[a.qa?.length||0," 个结果"]})]}),a.qa&&a.qa.length>0?a.qa.map(s=>e.jsx(h,{id:s.id,title:s.question,content:s.answer,score:s.hybrid_score,type:"qa"},s.id)):e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"没有找到精确匹配的结果"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"文档推荐(BM25)"}),e.jsxs(x,{variant:"outline",children:[a.doc_hybrid_bm25?.length||0," 个结果"]})]}),a.doc_hybrid_bm25&&a.doc_hybrid_bm25.length>0?a.doc_hybrid_bm25.map(s=>e.jsx(h,{id:s.id,title:s.question,content:s.answer,score:s.hybrid_score,type:"qa"},s.id)):e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"没有找到文档推荐结果"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"文档推荐(FTS)"}),e.jsxs(x,{variant:"outline",children:[a.doc_hybrid_rff?.length||0," 个结果"]})]}),a.doc_hybrid_rff&&a.doc_hybrid_rff.length>0?a.doc_hybrid_rff.map(s=>e.jsx(h,{id:s.id,title:s.question,content:s.answer,score:s.hybrid_score,type:"qa"},s.id)):e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"没有找到文档推荐结果"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"问答推荐"}),e.jsxs(x,{variant:"outline",children:[a.qa_hybrid?.length||0," 个结果"]})]}),a.qa_hybrid&&a.qa_hybrid.length>0?a.qa_hybrid.map(s=>e.jsx(h,{id:s.id,title:s.question,content:s.answer,score:s.hybrid_score,type:"qa"},s.id)):e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"没有找到问答推荐结果"})]})]}),!a&&!u&&!o&&e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx("div",{className:"mb-4",children:e.jsx(G,{className:"w-12 h-12 mx-auto text-gray-300"})}),e.jsx("p",{className:"text-lg mb-2",children:"开始搜索知识库"}),e.jsx("p",{className:"text-sm",children:"输入关键词来搜索相关问答和文档"})]}),a&&a&&!u&&e.jsx("div",{className:"text-center py-12 text-muted-foreground",children:(a.qa?.length||0)===0&&(a.qa_hybrid?.length||0)===0&&(a.doc_hybrid_rff?.length||0)===0&&(a.doc_hybrid_bm25?.length||0)===0&&e.jsxs("div",{children:[e.jsx("p",{className:"text-lg mb-2",children:"没有找到相关结果"}),e.jsx("p",{className:"text-sm",children:"请尝试使用不同的关键词进行搜索"})]})})]})}export{De as default};
