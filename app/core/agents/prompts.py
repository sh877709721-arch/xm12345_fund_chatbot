"""
意图分类到提示词的映射系统
根据意图分类结果返回相应的提示词
"""

from typing import Dict, Optional, List
from app.core.rule.intent import IntentClassifier, IntentResult
import logging

# 意图分类到提示词的映射字典
INTENT_PROMPT_MAPPING: Dict[str, str] = {
"公积金提取业务": """用户正在咨询公积金提取相关内容。请提供准确的提取信息，包括：
- 提取类型（购房/租房/离职/退休等）
- 提取条件和资格
- 所需申请材料
- 办理流程和渠道（线上/线下）
- 提取额度和到账时限""",

"公积金贷款业务": """用户正在咨询公积金贷款相关内容。请提供详细的贷款信息，包括：
- 贷款申请条件（缴存时长、征信等）
- 贷款额度计算方式
- 所需申请材料
- 办理流程和审批时限
- 还款方式和调整规则""",

"公积金缴存业务": """用户正在咨询公积金缴存相关内容。请提供准确的缴存信息，包括：
- 缴存基数和比例范围
- 缴存渠道和方式（单位/个人）
- 缴存变更（增员/减员/基数调整）流程
- 缓缴、补缴规定
- 缴存明细查询方式""",

"公积金退休提取办理": """用户正在咨询公积金退休提取相关内容。请注意要点：
- 提取条件（退休证、账户封存等）
- 所需申请材料
- 办理流程和渠道
- 提取额度和到账时限
- 离休提取的特殊规定""",

"个人账户信息变更": """用户正在咨询公积金个人账户变更相关内容。请提供准确的办理指南：
- 变更类型（姓名、身份证号、银行卡等）
- 所需申请材料
- 办理流程和渠道
- 办理时限和注意事项
- 单位代办与个人办理的差异""",

"公积金异地转移办理": """用户正在咨询公积金异地转移相关内容。请提供详细的办理指南：
- 转移条件和范围（省内/跨省）
- 办理流程（转出/转入）
- 所需申请材料
- 办理时限和查询方式
- 单位代办与个人办理的差异""",

"公积金代际互助业务": """用户正在咨询公积金代际互助相关内容。请提供详细的政策解读：
- 互助条件（购房时间、亲属关系等）
- 提取额度计算方式
- 所需申请材料
- 办理流程和渠道
- 政策实施时间和范围""",

"公积金租房提取业务": """用户正在咨询公积金租房提取相关内容。请提供准确的提取信息：
- 提取条件（无房证明、缴存时长等）
- 提取额度标准（固定/实际租金）
- 所需申请材料
- 办理流程和渠道
- 提取频次和到账时限""",

"公积金购房提取业务": """用户正在咨询公积金购房提取相关内容。请提供准确的提取信息：
- 提取条件（购房类型、产权要求等）
- 所需申请材料（合同、发票等）
- 办理流程和渠道
- 提取额度和限制
- 本地/异地购房的差异""",

"公积金还贷业务": """用户正在咨询公积金还贷相关内容。请提供详细的还贷信息：
- 还贷方式（逐月/按年/冲抵本金）
- 申请条件和材料
- 办理流程和渠道
- 还款额度调整规则
- 提前还款规定""",

"公积金账户封存与启封": """用户正在咨询公积金账户封存/启封相关内容。请提供准确的办理指南：
- 封存/启封条件（离职/入职等）
- 所需申请材料
- 办理流程和渠道（单位/个人）
- 办理时限和注意事项
- 对提取/贷款的影响""",

"公积金单位缴存业务": """用户正在咨询单位公积金缴存相关内容。请提供全面的缴存信息：
- 单位缴存登记流程
- 增员/减员操作步骤
- 汇缴/补缴/托收规定
- 单位账户信息变更流程
- 网厅操作常见问题""",

"公积金异地购房提取/贷款": """用户正在咨询异地公积金相关业务。请提供详细的政策信息：
- 异地购房提取条件和材料
- 异地贷款申请条件（缴存证明等）
- 办理流程和渠道
- 本地与异地政策差异
- 所需异地证明材料""",

"公积金账户查询业务": """用户正在咨询公积金账户查询相关内容。请提供准确的查询指南：
- 账户余额查询方式（线上/线下）
- 缴存明细查询渠道
- 业务办理进度查询方法
- 个人账户信息查询入口
- 查询常见问题处理""",

"公积金代际互助还贷业务": """用户正在咨询公积金代际互助还贷相关内容。请提供详细的业务信息：
- 互助还贷条件（亲属关系、贷款状态等）
- 所需申请材料
- 办理流程和渠道
- 互助额度和划扣规则
- 变更与终止流程""",

"公积金离职提取办理": """用户正在咨询公积金离职提取相关内容。请提供准确的办理指南：
- 提取条件（户籍、账户封存时长等）
- 所需申请材料（离职证明等）
- 办理流程和渠道
- 提取额度和到账时限
- 本地/外地户籍差异""",

"公积金还款方式调整": """用户正在咨询公积金还款方式调整相关内容。请提供详细的调整信息：
- 可调整的还款方式类型
- 申请条件和时间
- 所需材料和办理流程
- 调整生效时间
- 注意事项和限制""",

"公积金账户销户业务": """用户正在咨询公积金账户销户相关内容。请提供准确的办理指南：
- 销户条件（离职/出境定居/死亡等）
- 所需申请材料
- 办理流程和渠道
- 销户前注意事项
- 资金划拨方式""",

"公积金缴存纠纷处理": """用户正在咨询公积金缴存纠纷相关内容。请提供详细的解决方案：
- 常见纠纷类型（未缴/少缴/断缴等）
- 处理流程和受理部门
- 所需举证材料
- 处理时限和结果反馈
- 维权途径和建议""",

"公积金租房提取备案业务": """用户正在咨询租房提取备案相关内容。请提供准确的备案信息：
- 备案条件和适用场景
- 所需备案材料
- 备案流程和办理部门
- 备案后的提取规则
- 备案变更与注销""",

"公积金贷款提前还款业务": """用户正在咨询公积金贷款提前还款相关内容。请提供详细的办理信息：
- 提前还款条件（还款时长、额度等）
- 所需申请材料
- 办理流程和渠道
- 提前还款违约金规定
- 还款后的额度恢复规则""",

"公积金代际互助提取业务": """用户正在咨询代际互助提取相关内容。请提供准确的提取信息：
- 互助条件（亲属关系、购房场景等）
- 所需申请材料（关系证明、购房材料等）
- 办理流程和渠道
- 提取额度和限制
- 到账时限和查询方式""",

"公积金异地转入办理": """用户正在咨询公积金异地转入相关内容。请提供详细的办理指南：
- 转入条件和资格
- 所需申请材料（异地缴存证明等）
- 办理流程和操作步骤
- 转入时限和账户合并规则
- 常见问题处理""",

"公积金账户解封业务": """用户正在咨询公积金账户解封相关内容。请提供准确的办理指南：
- 解封条件（重新就业/缴存恢复等）
- 所需申请材料
- 办理流程和渠道（单位/个人）
- 解封生效时间
- 对提取/贷款的影响""",

"其他": """用户正在咨询其他公积金相关内容。请根据具体问题，结合公积金政策，提供准确、简洁的解答，重点聚焦用户核心诉求，无需拓展非必要信息。""",
}


def get_prompt_by_intent(intent_result: IntentResult) -> str:
    """
    根据意图分类结果获取对应的提示词

    Args:
        intent_result: 意图分类结果

    Returns:
        对应的提示词字符串
    """
    # 根据置信度选择最合适的意图
    intent = intent_result.intent

    # 如果置信度过低，使用"其他"类别的提示词
    if intent_result.confidence < 0.5:
        intent = "其他"

    # 获取提示词，如果没有找到则返回"其他"类别的提示词
    prompt = INTENT_PROMPT_MAPPING.get(intent, INTENT_PROMPT_MAPPING["其他"])

    # 添加置信度信息到提示词
    if intent_result.confidence >= 0.5:
        prompt = f"[意图识别: {intent} (置信度: {intent_result.confidence:.3f})]\n\n{prompt}"
    else:
        prompt = f"[意图识别: {intent} (置信度较低: {intent_result.confidence:.3f})]\n\n{prompt}"

    return prompt


def get_combined_prompt(intent_results: List[IntentResult], max_prompts: int = 2) -> str:
    """
    根据多个意图分类结果获取组合提示词

    Args:
        intent_results: 意图分类结果列表
        max_prompts: 最多组合的提示词数量

    Returns:
        组合的提示词字符串
    """
    if not intent_results:
        return INTENT_PROMPT_MAPPING["其他"]

    # 选择前几个置信度较高的结果
    top_results = intent_results[:max_prompts]

    if len(top_results) == 1:
        return get_prompt_by_intent(top_results[0])

    # 组合多个提示词
    prompts = []
    for i, result in enumerate(top_results):
        prompt = INTENT_PROMPT_MAPPING.get(result.intent, INTENT_PROMPT_MAPPING["其他"])
        prompts.append(f"[{i+1}] {result.intent} (置信度: {result.confidence:.3f})\n{prompt}")

    return "\n\n" + "="*50 + "\n\n".join(prompts)


def get_prompt_by_question(question: str, classifier: Optional[IntentClassifier] = None) -> str:
    """
    根据问题直接获取对应的提示词

    Args:
        question: 用户问题
        classifier: 意图分类器实例，如果不提供则创建新实例

    Returns:
        对应的提示词字符串
    """
    if classifier is None:
        classifier = IntentClassifier()

    # 进行意图分类
    results = classifier.classify(question)


    # 返回主要意图的提示词
    return get_prompt_by_intent(results[0]) if results else INTENT_PROMPT_MAPPING["其他"]

